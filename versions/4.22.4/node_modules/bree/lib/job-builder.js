"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var _require = require('path'),
    join = _require.join;

var isSANB = require('is-string-and-not-blank');

var isValidPath = require('is-valid-path');

var _require2 = require('boolean'),
    boolean = _require2.boolean;

var later = require('@breejs/later');

var _require3 = require('./job-utils'),
    isSchedule = _require3.isSchedule,
    parseValue = _require3.parseValue;

later.date.localTime(); // eslint-disable-next-line complexity

var buildJob = function buildJob(job, config) {
  if (isSANB(job)) {
    var path = join(config.root, job.endsWith('.js') || job.endsWith('.mjs') ? job : "".concat(job, ".").concat(config.defaultExtension));
    var jobObject = {
      name: job,
      path: path,
      timeout: config.timeout,
      interval: config.interval
    };

    if (isSANB(config.timezone)) {
      jobObject.timezone = config.timezone;
    }

    return jobObject;
  }

  if (typeof job === 'function') {
    var _path = "(".concat(job.toString(), ")()");

    var _jobObject = {
      name: job.name,
      path: _path,
      worker: {
        eval: true
      },
      timeout: config.timeout,
      interval: config.interval
    };

    if (isSANB(config.timezone)) {
      _jobObject.timezone = config.timezone;
    }

    return _jobObject;
  } // Process job.path


  if (typeof job.path === 'function') {
    var _path2 = "(".concat(job.path.toString(), ")()");

    job.path = _path2;
    job.worker = _objectSpread({
      eval: true
    }, job.worker);
  } else {
    var _path3 = isSANB(job.path) ? job.path : join(config.root, job.name.endsWith('.js') || job.name.endsWith('.mjs') ? job.name : "".concat(job.name, ".").concat(config.defaultExtension));

    if (isValidPath(_path3)) {
      job.path = _path3;
    } else {
      // Assume that it's a transformed eval string
      job.worker = _objectSpread({
        eval: true
      }, job.worker);
    }
  }

  if (typeof job.timeout !== 'undefined') {
    job.timeout = parseValue(job.timeout);
  }

  if (typeof job.interval !== 'undefined') {
    job.interval = parseValue(job.interval);
  } // Build cron


  if (typeof job.cron !== 'undefined') {
    if (isSchedule(job.cron)) {
      job.interval = job.cron; // Delete job.cron;
    } else {
      job.interval = later.parse.cron(job.cron, boolean(typeof job.hasSeconds === 'undefined' ? config.hasSeconds : job.hasSeconds));
    }
  } // If timeout was undefined, cron was undefined,
  // and date was undefined then set the default
  // (as long as the default timeout is >= 0)


  if (Number.isFinite(config.timeout) && config.timeout >= 0 && typeof job.timeout === 'undefined' && typeof job.cron === 'undefined' && typeof job.date === 'undefined' && typeof job.interval === 'undefined') {
    job.timeout = config.timeout;
  } // If interval was undefined, cron was undefined,
  // and date was undefined then set the default
  // (as long as the default interval is > 0, or it was a schedule, or it was valid)


  if ((Number.isFinite(config.interval) && config.interval > 0 || isSchedule(config.interval)) && typeof job.interval === 'undefined' && typeof job.cron === 'undefined' && typeof job.date === 'undefined') {
    job.interval = config.interval;
  }

  if (isSANB(config.timezone) && !job.timezone) {
    job.timezone = config.timezone;
  }

  return job;
};

module.exports = buildJob;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9qb2ItYnVpbGRlci5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiam9pbiIsImlzU0FOQiIsImlzVmFsaWRQYXRoIiwiYm9vbGVhbiIsImxhdGVyIiwiaXNTY2hlZHVsZSIsInBhcnNlVmFsdWUiLCJkYXRlIiwibG9jYWxUaW1lIiwiYnVpbGRKb2IiLCJqb2IiLCJjb25maWciLCJwYXRoIiwicm9vdCIsImVuZHNXaXRoIiwiZGVmYXVsdEV4dGVuc2lvbiIsImpvYk9iamVjdCIsIm5hbWUiLCJ0aW1lb3V0IiwiaW50ZXJ2YWwiLCJ0aW1lem9uZSIsInRvU3RyaW5nIiwid29ya2VyIiwiZXZhbCIsImNyb24iLCJwYXJzZSIsImhhc1NlY29uZHMiLCJOdW1iZXIiLCJpc0Zpbml0ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7ZUFBaUJBLE9BQU8sQ0FBQyxNQUFELEM7SUFBaEJDLEksWUFBQUEsSTs7QUFDUixJQUFNQyxNQUFNLEdBQUdGLE9BQU8sQ0FBQyx5QkFBRCxDQUF0Qjs7QUFDQSxJQUFNRyxXQUFXLEdBQUdILE9BQU8sQ0FBQyxlQUFELENBQTNCOztnQkFDb0JBLE9BQU8sQ0FBQyxTQUFELEM7SUFBbkJJLE8sYUFBQUEsTzs7QUFDUixJQUFNQyxLQUFLLEdBQUdMLE9BQU8sQ0FBQyxlQUFELENBQXJCOztnQkFDbUNBLE9BQU8sQ0FBQyxhQUFELEM7SUFBbENNLFUsYUFBQUEsVTtJQUFZQyxVLGFBQUFBLFU7O0FBRXBCRixLQUFLLENBQUNHLElBQU4sQ0FBV0MsU0FBWCxHLENBRUE7O0FBQ0EsSUFBTUMsUUFBUSxHQUFHLFNBQVhBLFFBQVcsQ0FBQ0MsR0FBRCxFQUFNQyxNQUFOLEVBQWlCO0FBQ2hDLE1BQUlWLE1BQU0sQ0FBQ1MsR0FBRCxDQUFWLEVBQWlCO0FBQ2YsUUFBTUUsSUFBSSxHQUFHWixJQUFJLENBQ2ZXLE1BQU0sQ0FBQ0UsSUFEUSxFQUVmSCxHQUFHLENBQUNJLFFBQUosQ0FBYSxLQUFiLEtB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RFosS0FFQSxPQUFPVCxHQUFHLENBQUNTLFFBQVgsS0FBd0IsV0FGeEIsSUFHQSxPQUFPVCxHQUFHLENBQUNjLElBQVgsS0FBb0IsV0FIcEIsSUFJQSxPQUFPZCxHQUFHLENBQUNILElBQVgsS0FBb0IsV0FMdEIsRUFNRTtBQUNBRyxJQUFBQSxHQUFHLENBQUNTLFFBQUosR0FBZVIsTUFBTSxDQUFDUSxRQUF0QjtBQUNEOztBQUVELE1BQUlsQixNQUFNLENBQUNVLE1BQU0sQ0FBQ1MsUUFBUixDQUFOLElBQTJCLENBQUNWLEdBQUcsQ0FBQ1UsUUFBcEMsRUFBOEM7QUFDNUNWLElBQUFBLEdBQUcsQ0FBQ1UsUUFBSixHQUFlVCxNQUFNLENBQUNTLFFBQXRCO0FBQ0Q7O0FBRUQsU0FBT1YsR0FBUDtBQUNELENBOUhEOztBQWdJQW1CLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnJCLFFBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBqb2luIH0gPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBpc1NBTkIgPSByZXF1aXJlKCdpcy1zdHJpbmctYW5kLW5vdC1ibGFuaycpO1xuY29uc3QgaXNWYWxpZFBhdGggPSByZXF1aXJlKCdpcy12YWxpZC1wYXRoJyk7XG5jb25zdCB7IGJvb2xlYW4gfSA9IHJlcXVpcmUoJ2Jvb2xlYW4nKTtcbmNvbnN0IGxhdGVyID0gcmVxdWlyZSgnQGJyZWVqcy9sYXRlcicpO1xuY29uc3QgeyBpc1NjaGVkdWxlLCBwYXJzZVZhbHVlIH0gPSByZXF1aXJlKCcuL2pvYi11dGlscycpO1xuXG5sYXRlci5kYXRlLmxvY2FsVGltZSgpO1xuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY29tcGxleGl0eVxuY29uc3QgYnVpbGRKb2IgPSAoam9iLCBjb25maWcpID0+IHtcbiAgaWYgKGlzU0FOQihqb2IpKSB7XG4gICAgY29uc3QgcGF0aCA9IGpvaW4oXG4gICAgICBjb25maWcucm9vdCxcbiAgICAgIGpvYi5lbmRzV2l0aCgnLmpzJykgfHwgam9iLmVuZHNXaXRoKCcubWpzJylcbiAgICAgICAgPyBqb2JcbiAgICAgICAgOiBgJHtqb2J9LiR7Y29uZmlnLmRlZmF1bHRFeHRlbnNpb259YFxuICAgICk7XG5cbiAgICBjb25zdCBqb2JPYmplY3QgPSB7XG4gICAgICBuYW1lOiBqb2IsXG4gICAgICBwYXRoLFxuICAgICAgdGltZW91dDogY29uZmlnLnRpbWVvdXQsXG4gICAgICBpbnRlcnZhbDogY29uZmlnLmludGVydmFsXG4gICAgfTtcbiAgICBpZiAoaXNTQU5CKGNvbmZpZy50aW1lem9uZSkpIHtcbiAgICAgIGpvYk9iamVjdC50aW1lem9uZSA9IGNvbmZpZy50aW1lem9uZTtcbiAgICB9XG5cbiAgICByZXR1cm4gam9iT2JqZWN0O1xuICB9XG5cbiAgaWYgKHR5cGVvZiBqb2IgPT09ICdmdW5jdGlvbicpIHtcbiAgICBjb25zdCBwYXRoID0gYCgke2pvYi50b1N0cmluZygpfSkoKWA7XG5cbiAgICBjb25zdCBqb2JPYmplY3QgPSB7XG4gICAgICBuYW1lOiBqb2IubmFtZSxcbiAgICAgIHBhdGgsXG4gICAgICB3b3JrZXI6IHsgZXZhbDogdHJ1ZSB9LFxuICAgICAgdGltZW91dDogY29uZmlnLnRpbWVvdXQsXG4gICAgICBpbnRlcnZhbDogY29uZmlnLmludGVydmFsXG4gICAgfTtcbiAgICBpZiAoaXNTQU5CKGNvbmZpZy50aW1lem9uZSkpIHtcbiAgICAgIGpvYk9iamVjdC50aW1lem9uZSA9IGNvbmZpZy50aW1lem9uZTtcbiAgICB9XG5cbiAgICByZXR1cm4gam9iT2JqZWN0O1xuICB9XG5cbiAgLy8gUHJvY2VzcyBqb2IucGF0aFxuICBpZiAodHlwZW9mIGpvYi5wYXRoID09PSAnZnVuY3Rpb24nKSB7XG4gICAgY29uc3QgcGF0aCA9IGAoJHtqb2IucGF0aC50b1N0cmluZygpfSkoKWA7XG5cbiAgICBqb2IucGF0aCA9IHBhdGg7XG4gICAgam9iLndvcmtlciA9IHtcbiAgICAgIGV2YWw6IHRydWUsXG4gICAgICAuLi5qb2Iud29ya2VyXG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBwYXRoID0gaXNTQU5CKGpvYi5wYXRoKVxuICAgICAgPyBqb2IucGF0aFxuICAgICAgOiBqb2luKFxuICAgICAgICAgIGNvbmZpZy5yb290LFxuICAgICAgICAgIGpvYi5uYW1lLmVuZHNXaXRoKCcuanMnKSB8fCBqb2IubmFtZS5lbmRzV2l0aCgnLm1qcycpXG4gICAgICAgICAgICA/IGpvYi5uYW1lXG4gICAgICAgICAgICA6IGAke2pvYi5uYW1lfS4ke2NvbmZpZy5kZWZhdWx0RXh0ZW5zaW9ufWBcbiAgICAgICAgKTtcblxuICAgIGlmIChpc1ZhbGlkUGF0aChwYXRoKSkge1xuICAgICAgam9iLnBhdGggPSBwYXRoO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBBc3N1bWUgdGhhdCBpdCdzIGEgdHJhbnNmb3JtZWQgZXZhbCBzdHJpbmdcbiAgICAgIGpvYi53b3JrZXIgPSB7XG4gICAgICAgIGV2YWw6IHRydWUsXG4gICAgICAgIC4uLmpvYi53b3JrZXJcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgaWYgKHR5cGVvZiBqb2IudGltZW91dCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICBqb2IudGltZW91dCA9IHBhcnNlVmFsdWUoam9iLnRpbWVvdXQpO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBqb2IuaW50ZXJ2YWwgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgam9iLmludGVydmFsID0gcGFyc2VWYWx1ZShqb2IuaW50ZXJ2YWwpO1xuICB9XG5cbiAgLy8gQnVpbGQgY3JvblxuICBpZiAodHlwZW9mIGpvYi5jcm9uICE9PSAndW5kZWZpbmVkJykge1xuICAgIGlmIChpc1NjaGVkdWxlKGpvYi5jcm9uKSkge1xuICAgICAgam9iLmludGVydmFsID0gam9iLmNyb247XG4gICAgICAvLyBEZWxldGUgam9iLmNyb247XG4gICAgfSBlbHNlIHtcbiAgICAgIGpvYi5pbnRlcnZhbCA9IGxhdGVyLnBhcnNlLmNyb24oXG4gICAgICAgIGpvYi5jcm9uLFxuICAgICAgICBib29sZWFuKFxuICAgICAgICAgIHR5cGVvZiBqb2IuaGFzU2Vjb25kcyA9PT0gJ3VuZGVmaW5lZCdcbiAgICAgICAgICAgID8gY29uZmlnLmhhc1NlY29uZHNcbiAgICAgICAgICAgIDogam9iLmhhc1NlY29uZHNcbiAgICAgICAgKVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvLyBJZiB0aW1lb3V0IHdhcyB1bmRlZmluZWQsIGNyb24gd2FzIHVuZGVmaW5lZCxcbiAgLy8gYW5kIGRhdGUgd2FzIHVuZGVmaW5lZCB0aGVuIHNldCB0aGUgZGVmYXVsdFxuICAvLyAoYXMgbG9uZyBhcyB0aGUgZGVmYXVsdCB0aW1lb3V0IGlzID49IDApXG4gIGlmIChcbiAgICBOdW1iZXIuaXNGaW5pdGUoY29uZmlnLnRpbWVvdXQpICYmXG4gICAgY29uZmlnLnRpbWVvdXQgPj0gMCAmJlxuICAgIHR5cGVvZiBqb2IudGltZW91dCA9PT0gJ3VuZGVmaW5lZCcgJiZcbiAgICB0eXBlb2Ygam9iLmNyb24gPT09ICd1bmRlZmluZWQnICYmXG4gICAgdHlwZW9mIGpvYi5kYXRlID09PSAndW5kZWZpbmVkJyAmJlxuICAgIHR5cGVvZiBqb2IuaW50ZXJ2YWwgPT09ICd1bmRlZmluZWQnXG4gICkge1xuICAgIGpvYi50aW1lb3V0ID0gY29uZmlnLnRpbWVvdXQ7XG4gIH1cblxuICAvLyBJZiBpbnRlcnZhbCB3YXMgdW5kZWZpbmVkLCBjcm9uIHdhcyB1bmRlZmluZWQsXG4gIC8vIGFuZCBkYXRlIHdhcyB1bmRlZmluZWQgdGhlbiBzZXQgdGhlIGRlZmF1bHRcbiAgLy8gKGFzIGxvbmcgYXMgdGhlIGRlZmF1bHQgaW50ZXJ2YWwgaXMgPiAwLCBvciBpdCB3YXMgYSBzY2hlZHVsZSwgb3IgaXQgd2FzIHZhbGlkKVxuICBpZiAoXG4gICAgKChOdW1iZXIuaXNGaW5pdGUoY29uZmlnLmludGVydmFsKSAmJiBjb25maWcuaW50ZXJ2YWwgPiAwKSB8fFxuICAgICAgaXNTY2hlZHVsZShjb25maWcuaW50ZXJ2YWwpKSAmJlxuICAgIHR5cGVvZiBqb2IuaW50ZXJ2YWwgPT09ICd1bmRlZmluZWQnICYmXG4gICAgdHlwZW9mIGpvYi5jcm9uID09PSAndW5kZWZpbmVkJyAmJlxuICAgIHR5cGVvZiBqb2IuZGF0ZSA9PT0gJ3VuZGVmaW5lZCdcbiAgKSB7XG4gICAgam9iLmludGVydmFsID0gY29uZmlnLmludGVydmFsO1xuICB9XG5cbiAgaWYgKGlzU0FOQihjb25maWcudGltZXpvbmUpICYmICFqb2IudGltZXpvbmUpIHtcbiAgICBqb2IudGltZXpvbmUgPSBjb25maWcudGltZXpvbmU7XG4gIH1cblxuICByZXR1cm4gam9iO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBidWlsZEpvYjtcbiJdfQ==